# ç±»ç»„ä»¶çš„æ¸²æŸ“å’Œæ›´æ–°æµç¨‹

### åˆ›å»ºç±»ç»„ä»¶


åˆ›å»ºç±»ç»„ä»¶è¦æ±‚å¿…é¡»ç»§æ‰¿`React.Component/PureComponent`è¿™ä¸ªç±», ä¸”å¿…é¡»ç»™å½“å‰ç±»è®¾ç½®ä¸€ä¸ª`render`çš„æ–¹æ³•ã€Œæ”¾åœ¨å…¶åŸå‹ä¸Šã€ï¼šåœ¨`render`æ–¹æ³•ä¸­ï¼Œè¿”å›éœ€è¦æ¸²æŸ“çš„è§†å›¾

```jsx
import React from 'react'
class Vote extends React.Component {
    state = {
    }
    render() {
        return (
            <div>
            </div>
        )
    }
}

export default Vote;
```
```jsx
function Component(props,context,updater) {
    this.props = props;
    this.context = context;
    this.refs = {};
    this.updater = updater || ReactNoopUpdateQueue;
}

import React from 'react'
class Parent extends React.Component {
    constructor(props) {
        super(props)
    }
    state = {
    }
    render() {
        return (
            <div>
            </div>
        )
    }
}

export default Parent;
/*
renderå‡½æ•°åœ¨æ¸²æŸ“çš„æ—¶å€™ï¼Œå¦‚æœtypeæ˜¯ï¼š
- å­—ç¬¦ä¸²ï¼šåˆ›å»ºä¸€ä¸ªæ ‡ç­¾
- æ™®é€šå‡½æ•°ï¼šæŠŠå‡½æ•°æ‰§è¡Œï¼Œå¹¶ä¸”æŠŠpropsä¼ é€’ç»™å‡½æ•°
- æ„é€ å‡½æ•°ï¼šæŠŠæ„é€ å‡½æ•°åŸºäºnewæ‰§è¡Œï¼ˆåˆ›å»ºç±»çš„å®ä¾‹ï¼‰ï¼ŒæŠŠè§£æçš„propsä¼ é€’è¿‡å»
    - æ¯è°ƒç”¨ä¸€æ¬¡ç±»ç»„ä»¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å®ä¾‹
    - æŠŠç±»ç»„ä»¶ç¼–å†™çš„renderå‡½æ•°æ‰§è¡Œï¼ŒæŠŠè¿”å›çš„jsx(è™šæ‹ŸDOMï¼‰å½“åšç»„ä»¶è§†å›¾è¿›è¡Œæ¸²æŸ“ã€‚
*/
```
åŸºäº`extends`å®ç°ç»§æ‰¿çš„è¿‡ç¨‹

1. é¦–å…ˆåŸºäº`call`ç»§æ‰¿ ï¼Œ`React.Component.call(this)`ï¼Œ**ç»™åˆ›å»ºçš„ç»„ä»¶å®ä¾‹è®¾ç½®å››ä¸ªç§æœ‰å±æ€§**: `propsã€contextã€refsã€updater`
2. å†åŸºäºåŸå‹ç»§æ‰¿ï¼Œ`Parent.prototype.__proto__ === React.Component.prototype`
- `paretnt â€”> Parent.prototype -> React.Component.prototype -> Object.prototype`
- å®ä¾‹é™¤äº†å…·å¤‡`Parent.prototype`æä¾›çš„æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜å…·å¤‡äº†`React.Component.prototype`åŸå‹ä¸Šæä¾›çš„æ–¹æ³•ï¼š`isReactComponent, setState, forceUpdate`
3. åªè¦è‡ªå·±è®¾ç½®äº†`constructor,`åˆ™å†…éƒ¨ç¬¬ä¸€è¡Œä»£ç è¦æ‰§è¡Œ`super()`
### ç±»ç»„ä»¶çš„æ¸²æŸ“æµç¨‹
ä»è°ƒç”¨ç±»ç»„ä»¶`new Vote({})`å¼€å§‹ï¼Œç±»ç»„ä»¶å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…ï¼š

1. `åˆå§‹åŒ–å±æ€§ && è§„åˆ™æ ¡éªŒ`, å…ˆè§„åˆ™æ ¡éªŒï¼Œæ ¡éªŒå®Œæ¯•åï¼Œå†å¤„ç†å±æ€§çš„å…¶ä»–æ“ä½œ
```javascript
  constructor(props) {
    super(props); //ä¼šæŠŠä¼ é€’è¿›æ¥çš„å±æ€§æŒ‚è½½åˆ°thiså®ä¾‹ä¸Š
    console.log(this.props); //è·å–åˆ°ä¼ é€’çš„å±æ€§
  }
```
å³ä¾¿æˆ‘ä»¬è‡ªå·±ä¸åœ¨`constructor`ä¸­å¤„ç†(æˆ–è€…`constructor`éƒ½æ²¡å†™)ï¼Œåœ¨`constructor`å¤„ç†å®Œæ¯•åï¼ŒReactå†…éƒ¨ä¹Ÿä¼šæŠŠä¼ é€’çš„propsæŒ‚è½½åˆ°å®ä¾‹ä¸Šï¼›æ‰€ä»¥åœ¨å…¶ä»–çš„å‡½æ•°ä¸­ï¼Œåªè¦ä¿è¯`this`æ˜¯å®ä¾‹ï¼Œå°±å¯ä»¥åŸºäº`this.props`è·å–ä¼ é€’çš„å±æ€§, `this.props`è·å–çš„å±æ€§å¯¹è±¡æ˜¯è¢«å†»ç»“çš„(åªè¯»çš„)

2. `åˆå§‹åŒ–çŠ¶æ€`
   1. å¦‚æœæˆ‘ä»¬æ²¡æœ‰åšä»»ä½•çš„å¤„ç†ï¼Œ`React`å†…éƒ¨ä¼šå¸®æˆ‘ä»¬é»˜è®¤è®¾ç½®ä¸€ä¸ª`state`, å€¼ä¸º`null`, å³`this.state = null`
   2. æ›´å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯ç”¨ä»£ç çš„æ–¹å¼æ‰‹åŠ¨æŒ‡å®šï¼Œ`state = {}`
   3. å½“é€šè¿‡`setState`ä¿®æ”¹`state`ä¸­çš„å€¼æ—¶ï¼Œä¼šè§¦å‘`React`çš„æ›´æ–°æµç¨‹ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº†`this.state.xxx = newValue`è¿™æ ·çš„æ–¹å¼ï¼Œåªä¼šæ”¹å˜`state`ä¸­çš„å€¼ï¼Œå¹¶ä¸ä¼šè§¦å‘æ›´æ–°æµç¨‹ã€‚
   4. æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡`forceUpdate`çš„æ–¹å¼å¼ºåˆ¶è§†å›¾æ›´æ–°
3. è§¦å‘`componentWillMount`ç”Ÿå‘½å‘¨æœŸå‡½æ•°(ç”Ÿå‘½å‘¨æœŸé’©å­ï¼‰
> ğŸ§¡ é’©å­å‡½æ•°ï¼šåœ¨ç¨‹åºè¿è¡Œåˆ°æŸä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºæä¾›ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œè®©å¼€å‘è€…åœ¨è¿™ä¸ªé˜¶æ®µåšä¸€äº›è‡ªå®šä¹‰çš„äº‹æƒ…

   - `React`å®˜æ–¹æ‰“ç®—ç§»é™¤è¿™ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œæ‰€ä»¥å°†è¿™ä¸ªå‡½æ•°è®¾ç½®ä¸º`ä¸å®‰å…¨çš„`ï¼Œæ‰€ä»¥ä¼šåœ¨æ§åˆ¶å°ä¸­è¾“å‡ºé»„è‰²è­¦å‘Šâš ï¸ï¼Œ å¦‚æœæƒ³è¦ç§»é™¤è¿™ä¸ªé»„è‰²è­¦å‘Šï¼Œå¯ä»¥ä½¿ç”¨ `UNSAFE_componentWillMount`
   - å¦‚æœæˆ‘ä»¬å¼€å¯äº†`StrictModeä¸¥æ ¼æ¨¡å¼`ï¼ˆæ£€æŸ¥ä¸è§„èŒƒçš„è¯­æ³•æˆ–ä¸å»ºè®®ä½¿ç”¨çš„APIï¼‰ ï¼Œåˆ™ä½¿ç”¨`UNSAFE_componentWillMount`æ—¶ï¼Œæ§åˆ¶å°ä¼šç›´æ¥å‘å‡ºçº¢è‰²è­¦å‘ŠğŸš¨
4. è§¦å‘`render`å‡½æ•°ï¼Œæ¸²æŸ“å†…å®¹
5. è§¦å‘`componentDidMount`ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œç¬¬ä¸€æ¬¡æ¸²æŸ“å®Œæ¯•ï¼Œåœ¨æ­¤é˜¶æ®µæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°`DOM`å…ƒç´ 
### ç±»ç»„ä»¶çš„æ›´æ–°æµç¨‹
:::info
ç»„ä»¶æ›´æ–°çš„é€»è¾‘ã€Œç¬¬ä¸€ç§ï¼šç»„ä»¶å†…éƒ¨çš„çŠ¶æ€è¢«ä¿®æ”¹ï¼Œç»„ä»¶ä¼šæ›´æ–°ã€

1. è§¦å‘ `shouldComponentUpdate`å‘¨æœŸå‡½æ•°ï¼šæ˜¯å¦å…è®¸æ›´æ–°, è¿”å›ç»“æœä¸º`true/flase`, å¦‚æœç»“æœä¸º`true`, åˆ™å…è®¸æ›´æ–°ï¼Œå¹¶æ‰§è¡Œåé¢çš„æ“ä½œï¼Œå¦‚æœè¿”å›ç»“æœä¸º`false`,åˆ™ä¸è¿›è¡Œæ›´æ–°
2. è§¦å‘ `componentWillUpdate`å‘¨æœŸå‡½æ•°ï¼šæ›´æ–°ä¹‹å‰
- æ­¤å‘¨æœŸå‡½æ•°ä¹Ÿæ˜¯ä¸å®‰å…¨çš„, åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒçŠ¶æ€/å±æ€§è¿˜æ²¡æœ‰è¢«ä¿®æ”¹
3. ä¿®æ”¹çŠ¶æ€å€¼/å±æ€§å€¼`setState`, è®©`this.state.xxx`æ”¹ä¸ºæœ€æ–°çš„å€¼
4. è§¦å‘ `render `å‘¨æœŸå‡½æ•°ï¼šç»„ä»¶æ›´æ–°
- æŒ‰ç…§æœ€æ–°çš„çŠ¶æ€/å±æ€§ï¼ŒæŠŠè¿”å›çš„JSXç¼–è¯‘ä¸ºvirtualDOM
- å’Œä¸Šä¸€æ¬¡æ¸²æŸ“å‡ºæ¥çš„virtualDOMè¿›è¡Œå¯¹æ¯”`ã€ŒDOM-DIFFã€`
- æŠŠå·®å¼‚çš„éƒ¨åˆ†è¿›è¡Œæ¸²æŸ“ã€Œæ¸²æŸ“ä¸ºçœŸå®çš„DOMã€
5. è§¦å‘`componentDidUpdate`å‘¨æœŸå‡½æ•°ï¼šç»„ä»¶æ›´æ–°å®Œæ¯•

ç‰¹æ®Šè¯´æ˜ï¼šå¦‚æœæˆ‘ä»¬æ˜¯åŸºäº `this.forceUpdate()`å¼ºåˆ¶æ›´æ–°è§†å›¾ï¼Œä¼šè·³è¿‡ `shouldComponentUpdate`å‘¨æœŸå‡½æ•°çš„æ ¡éªŒï¼Œç›´æ¥ä»`componentWillUpdate`å¼€å§‹è¿›è¡Œæ›´æ–°ã€Œä¹Ÿå°±æ˜¯ï¼šè§†å›¾ä¸€å®šä¼šè§¦å‘æ›´æ–°ã€ï¼
:::
:::warning
ç»„ä»¶æ›´æ–°çš„é€»è¾‘ã€Œç¬¬äºŒç§ï¼šçˆ¶ç»„ä»¶æ›´æ–°ï¼Œè§¦å‘çš„å­ç»„ä»¶æ›´æ–°ã€

1. è§¦å‘ `componentWillReceiveProps `å‘¨æœŸå‡½æ•°ï¼šæ¥æ”¶æœ€æ–°å±æ€§ä¹‹å‰, è¯¥å‘¨æœŸå‡½æ•°æ˜¯ä¸å®‰å…¨çš„
2. è§¦å‘ `shouldComponentUpdate` å‘¨æœŸå‡½æ•°

ä¹‹åçš„æ“ä½œå’Œç»„ä»¶çš„ç¬¬ä¸€ç§æ›´æ–°é€»è¾‘ç›¸åŒ

ç»„ä»¶å¸è½½çš„é€»è¾‘

1. è§¦å‘ `componentWillUnmount`å‘¨æœŸå‡½æ•°ï¼šç»„ä»¶é”€æ¯ä¹‹å‰
2. é”€æ¯

çˆ¶å­ç»„ä»¶åµŒå¥—ï¼Œå¤„ç†æœºåˆ¶ä¸Šéµå¾ª**æ·±åº¦ä¼˜å…ˆ**åŸåˆ™ï¼šçˆ¶ç»„ä»¶åœ¨æ“ä½œä¸­ï¼Œé‡åˆ°å­ç»„ä»¶ï¼Œä¸€å®šæ˜¯æŠŠå­ç»„ä»¶å¤„ç†å®Œï¼Œçˆ¶ç»„ä»¶æ‰èƒ½ç»§ç»­å¤„ç†

- _çˆ¶ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“_

 çˆ¶ willMount -> çˆ¶ renderã€Œå­ willMount -> å­ render -> å­didMountã€ -> çˆ¶didMount 

- _çˆ¶ç»„ä»¶æ›´æ–°ï¼š_

çˆ¶ shouldUpdate -> çˆ¶willUpdate -> çˆ¶ render ã€Œå­willReceiveProps -> å­ shouldUpdate -> å­willUpdate -> å­ render -> å­ didUpdateã€-> çˆ¶ didUpdate

- _çˆ¶ç»„ä»¶é”€æ¯ï¼š_

çˆ¶ willUnmount -> å¤„ç†ä¸­ã€Œå­willUnmount -> å­é”€æ¯ã€-> çˆ¶é”€æ¯
:::
```jsx
shouldComponentUpdate(nextProps,nextState) {
     // nextState:å­˜å‚¨è¦ä¿®æ”¹çš„æœ€æ–°çŠ¶æ€
     // this.state:å­˜å‚¨çš„è¿˜æ˜¯ä¿®æ”¹å‰çš„çŠ¶æ€ã€Œæ­¤æ—¶çŠ¶æ€è¿˜æ²¡æœ‰æ”¹å˜ã€
     console.log(this.state, nextState);
    
     // æ­¤å‘¨æœŸå‡½æ•°éœ€è¦è¿”å›true/false
     //   è¿”å›trueï¼šå…è®¸æ›´æ–°ï¼Œä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªæ“ä½œ
     //   è¿”å›falseï¼šä¸å…è®¸æ›´æ–°ï¼Œæ¥ä¸‹æ¥å•¥éƒ½ä¸å¤„ç†
     return true;
}
UNSAFE_componentWillUpdate(nextProps, nextState) {
    console.log('componentWillUpdate:', this.props, nextProps);
}

UNSAFE_componentWillReceiveProps(nextProps) {
    // this.props:å­˜å‚¨ä¹‹å‰çš„å±æ€§
    // nextProps:ä¼ é€’è¿›æ¥çš„æœ€æ–°å±æ€§å€¼
    console.log('componentWillReceiveProps:', this.props, nextProps);
}
```
### `PureComponent`
å½“æˆ‘ä»¬å®šä¹‰ç±»ç»„ä»¶çš„æ—¶å€™ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹ä¸¤ç§å½¢å¼ï¼š
```javascript
import React from 'react';

class Demo1 extends React.PureComponent {}

class Demo2 extends React.Component {}
```
é‚£ä¹ˆï¼Œå®šä¹‰çš„ç»„ä»¶ç»§æ‰¿`PureComponent/Component`æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ
:::info
ç›¸æ¯”äº`Component`, `PureComponent`ä¼šç»™ç±»ç»„ä»¶é»˜è®¤åŠ ä¸€ä¸ª`shouldComponentUpdate`å‘¨æœŸå‡½æ•°

- _åœ¨æ­¤å‘¨æœŸå‡½æ•°ä¸­ï¼Œå®ƒå¯¹æ–°è€çš„å±æ€§/çŠ¶æ€ ä¼šåšä¸€ä¸ª**æµ…æ¯”è¾ƒ**_
- _å¦‚æœç»è¿‡æµ…æ¯”è¾ƒï¼Œå‘ç°å±æ€§å’ŒçŠ¶æ€å¹¶æ²¡æœ‰æ”¹å˜ï¼Œåˆ™è¿”å›falseã€Œä¹Ÿå°±æ˜¯ä¸ç»§ç»­æ›´æ–°ç»„ä»¶ã€ï¼›æœ‰å˜åŒ–æ‰ä¼šå»æ›´æ–°ï¼ï¼_
:::
### ![image.png](../pics/1686575818570-03dac13a-298d-40d5-be06-3b921067bec8-20230823235746307.png)
```javascript
// æ£€æµ‹æ˜¯å¦ä¸ºå¯¹è±¡
const isObject = function isObject(obj) {
    return obj !== null && /^(object|function)$/.test(typeof obj);
};

// å¯¹è±¡æµ…æ¯”è¾ƒçš„æ–¹æ³•
const shallowEqual = function shallowEqual(objA, objB) {
    if (!isObject(objA) || !isObject(objB)) return false;
    if (objA === objB) return true;
    // å…ˆæ¯”è¾ƒæˆå‘˜çš„æ•°é‡
    let keysA = Reflect.ownKeys(objA),
        keysB = Reflect.ownKeys(objB);
    if (keysA.length !== keysB.length) return false;
    // æ•°é‡ä¸€è‡´ï¼Œå†é€ä¸€æ¯”è¾ƒå†…éƒ¨çš„æˆå‘˜ã€Œåªæ¯”è¾ƒç¬¬ä¸€çº§ï¼šæµ…æ¯”è¾ƒã€
    for (let i = 0; i < keysA.length; i++) {
        let key = keysA[i];
        // å¦‚æœä¸€ä¸ªå¯¹è±¡ä¸­æœ‰è¿™ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªå¯¹è±¡ä¸­æ²¡æœ‰ï¼›æˆ–è€…ï¼Œéƒ½æœ‰è¿™ä¸ªæˆå‘˜ï¼Œä½†æ˜¯æˆå‘˜å€¼ä¸ä¸€æ ·ï¼›éƒ½åº”è¯¥è¢«åˆ¤å®šä¸ºä¸ç›¸åŒï¼ï¼
        if (!objB.hasOwnProperty(key) || !Object.is(objA[key], objB[key])) {
            return false;
        }
    }
    // ä»¥ä¸Šéƒ½å¤„ç†å®Œï¼Œå‘ç°æ²¡æœ‰ä¸ç›¸åŒçš„æˆå‘˜ï¼Œåˆ™è®¤ä¸ºä¸¤ä¸ªå¯¹è±¡æ˜¯ç›¸ç­‰çš„
    return true;
};

```
```javascript
shouldComponentUpdate(nextProps, nextState) {
    let { props, state } = this;
    // props/stateï¼šä¿®æ”¹ä¹‹å‰çš„å±æ€§çŠ¶æ€
    // nextProps/nextStateï¼šå°†è¦ä¿®æ”¹çš„å±æ€§çŠ¶æ€
    // æœ‰ä¸€é¡¹è¿”å›ç»“æœä¸ºfalse(propsæˆ–è€…stateæ›´æ”¹), shouldComponentUpdateæ‰ä¼šè¿”å›true
    return !shallowEqual(props, nextProps) || !shallowEqual(state, nextState);
} 

// å½“å¾€stateä¸­çš„arrè¿›è¡Œæ“ä½œåï¼Œarrçš„åœ°å€å¹¶æ²¡æœ‰æ›´æ”¹ï¼Œä¸ºäº†è®©ç»„ä»¶æ›´æ–°ï¼Œå¤åˆ¶ä¸€ä»½æ”¾åœ¨æ–°æ•°ç»„ä¸­
this.setState({
   arr: [...arr] //æˆ‘ä»¬æ˜¯è®©arrçŠ¶æ€å€¼æ”¹ä¸ºä¸€ä¸ªæ–°çš„æ•°ç»„ã€Œå †åœ°å€ã€
})
```
### å¯¹è±¡çš„å¯†å°ã€å†»ç»“å’Œå°è£…

1. å†»ç»“
å†»ç»“å¯¹è±¡ï¼š`Object.freeze(obj)`
æ£€æµ‹æ˜¯å¦è¢«å†»ç»“ï¼š`Object.isFrozen(obj) => true/false`
è¢«å†»ç»“çš„å¯¹è±¡ï¼šä¸èƒ½ä¿®æ”¹æˆå‘˜å€¼ã€ä¸èƒ½æ–°å¢æˆå‘˜ã€ä¸èƒ½åˆ é™¤ç°æœ‰æˆå‘˜ã€ä¸èƒ½ç»™æˆå‘˜åšåŠ«æŒ`Object.defineProperty`
2. å¯†å°
å¯†å°å¯¹è±¡ï¼š`Object.seal(obj)`
æ£€æµ‹æ˜¯å¦è¢«å¯†å°ï¼š`Object.isSealed(obj)`
è¢«å¯†å°çš„å¯¹è±¡ï¼š**å¯ä»¥ä¿®æ”¹æˆå‘˜çš„å€¼**ï¼Œä½†ä¹Ÿä¸èƒ½åˆ ã€ä¸èƒ½æ–°å¢ã€ä¸èƒ½åŠ«æŒ
3. æ‰©å±•
æŠŠå¯¹è±¡è®¾ç½®ä¸ºä¸å¯æ‰©å±•ï¼š`Object.preventExtensions(obj)`
æ£€æµ‹æ˜¯å¦å¯æ‰©å±•ï¼š`Object.isExtensible(obj)`
è¢«è®¾ç½®ä¸å¯æ‰©å±•çš„å¯¹è±¡ï¼šé™¤äº†ä¸èƒ½æ–°å¢æˆå‘˜ã€å…¶ä½™çš„æ“ä½œéƒ½å¯ä»¥å¤„ç†
è¢«å†»ç»“çš„å¯¹è±¡ï¼Œæ—¢æ˜¯ä¸å¯æ‰©å±•çš„ï¼Œä¹Ÿæ˜¯å¯†å°çš„ï¼ŒåŒç†ï¼Œè¢«å¯†å°çš„å¯¹è±¡ï¼Œä¹Ÿæ˜¯ä¸å¯æ‰©å±•çš„ã€‚
